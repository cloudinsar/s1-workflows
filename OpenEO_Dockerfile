# docker build -t openeo_insar:1.46 . -f OpenEO_Dockerfile
# skopeo copy --multi-arch=all --format=oci docker-daemon:openeo_insar:1.46 docker://registry.stag.warsaw.openeo.dataspace.copernicus.eu/rand/openeo_insar:1.46
# docker run -it --memory=15G -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY --rm openeo_insar:1.46
FROM ghcr.io/osgeo/gdal:ubuntu-small-3.10.0

SHELL ["/bin/bash", "-euo", "pipefail", "-c"]

ENV DEBIAN_FRONTEND=noninteractive \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8

# Install necessary packages
RUN apt-get -qq update && \
    apt-get -qq install -y \
        jq \
        xmlstarlet \
        zip \
        default-jre \
        bc \
        nano \
        wget \
        curl \
        parallel \
        dpkg \
        software-properties-common && \
    rm -rf /var/lib/apt/lists/*

# Download and install jacksum and s5cmd
RUN curl -sL -O 'https://s3.waw3-2.cloudferro.com/swift/v1/jacksum/jacksum_1.7.0-4.1_all.deb' && \
    dpkg -i jacksum_1.7.0-4.1_all.deb && rm jacksum_1.7.0-4.1_all.deb && \
    curl -sL -O 'https://github.com/peak/s5cmd/releases/download/v2.2.2/s5cmd_2.2.2_linux_amd64.deb' && \
    dpkg -i s5cmd_2.2.2_linux_amd64.deb && rm s5cmd_2.2.2_linux_amd64.deb

#COPY ./utilities /src/utilities/ # Copy at the end of file to avoid slow rebuilds
ENV PATH="${PATH}:/src/utilities/"

RUN add-apt-repository -y ppa:deadsnakes/ppa
RUN apt-get -qq update && \
    apt-get -qq install -y \
      build-essential \
      git \
      python3.11 python3.11-distutils python3.11-dev python3.11-venv \
      cmake \
      autoconf \
      libgfortran5

LABEL authors="Michele Claus, Emile Sonneveld"
LABEL maintainer="michele.claus@eurac.edu, emile.sonneveld@vito.be"

### Install esa-snap ###
ENV SNAPVER=11

RUN mkdir -p /src/esa-snap-docker
COPY esa-snap-docker/response.varfile /src/esa-snap-docker/response.varfile

# install and update snap
RUN wget -q -O /src/esa-snap-docker/esa-snap_all_unix_${SNAPVER}_0_0.sh "https://step.esa.int/downloads/${SNAPVER}.0/installers/esa-snap_all_linux-${SNAPVER}.0.0.sh" && \
   sh /src/esa-snap-docker/esa-snap_all_unix_${SNAPVER}_0_0.sh -q -varfile /src/esa-snap-docker/response.varfile && \
   rm -f /src/esa-snap-docker/esa-snap_all_unix_${SNAPVER}_0_0.sh

# update SNAP
COPY esa-snap-docker/update_snap.sh /src/esa-snap-docker/update_snap.sh
RUN bash /src/esa-snap-docker/update_snap.sh

# add gpt to PATH
ENV PATH="${PATH}:/usr/local/esa-snap/bin"

COPY pyproject.toml /src/pyproject.toml
# . /opt/venv/bin/activate -> has no effect in Docker, here we need the following line:
ENV PATH="/opt/venv/bin:$PATH"
RUN python3.11 -m venv /opt/venv && \
    cd /src && \
    mkdir sar && \
    pip config set global.disable-pip-version-check true && \
    python3 -m pip install -q . && \
    python3 -m pip install -q --config-settings="--build-option=build_ext" --config-settings="--build-option=-I/usr/include/gdal" GDAL==`gdal-config --version`

ENV PATH="${PATH}:/src/"

# simple_stac_builder is good enough
#RUN cd /opt && \
#    git clone --recursive https://github.com/VitoTAP/stac-catalog-builder.git --depth 1 && \
#    cd stac-catalog-builder && \
#    python3 -m pip install -q -e .

RUN wget https://step.esa.int/thirdparties/snaphu/2.0.4/snaphu-v2.0.4_linux.zip && \
    unzip -q -d /opt snaphu-v2.0.4_linux.zip && \
    chmod +x /opt/snaphu-v2.0.4_linux/bin/snaphu && \
    rm snaphu-v2.0.4_linux.zip
ENV PATH="$PATH:/opt/snaphu-v2.0.4_linux/bin"

# COPY . /src
COPY cwl/ /src/cwl/
COPY ./utilities /src/utilities/
COPY ./notebooks/ /src/notebooks/
COPY ./sar /src/sar/
COPY *.sh /src/


WORKDIR /src
